# =============================================================================
# Deploy backend - Todos los clientes
# =============================================================================
# Enfoque: el backend se despliega ÃšNICAMENTE con este workflow.
#   - VPS1 (env all-clients): script que recorre api.* en /home.
#   - VPS2 (env heroedelwhisky): deploy inline para Heroe del Whisky.
# El frontend se despliega uno por uno con el workflow de cada cliente
# (deploy-client-heladitos, deploy-client-kioscoel11, etc.).
# =============================================================================

name: ðŸš€ Deploy backend - Todos los clientes

on:
  push:
    branches: [master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      skip_vps1:
        description: 'Omitir VPS1 (todos menos Heroe)'
        required: false
        default: false
        type: boolean
      skip_heroe:
        description: 'Omitir Heroe (VPS2)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-all-backend
  cancel-in-progress: false

jobs:
  deploy_vps1_all:
    name: Deploy VPS1 (todos menos Heroe)
    runs-on: ubuntu-latest
    environment: all-clients
    timeout-minutes: 25
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_vps1 != 'true' }}
    steps:
      - name: Descargar y ejecutar script de deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -e
            REPO="${{ github.repository }}"
            REF="${{ github.ref_name }}"
            URL="https://raw.githubusercontent.com/${REPO}/${REF}/scripts/deploy-all-clients-server.sh"
            echo "ðŸ“¥ Descargando script desde ${URL}..."
            curl -sfL "${URL}" -o /tmp/deploy-all-clients-server.sh
            chmod +x /tmp/deploy-all-clients-server.sh
            /tmp/deploy-all-clients-server.sh
          script_stop: true

  deploy_heroe:
    name: Deploy Heroe (VPS2)
    runs-on: ubuntu-latest
    environment: heroedelwhisky
    timeout-minutes: 12
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_heroe != 'true' }}
    steps:
      - name: Deploy backend Heroe del Whisky
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CLIENT_HEROE_VPS_HOST }}
          port: ${{ secrets.CLIENT_HEROE_VPS_PORT }}
          username: ${{ secrets.CLIENT_HEROE_VPS_USERNAME }}
          key: ${{ secrets.CLIENT_HEROE_VPS_SSH_KEY }}
          timeout: 60s
          command_timeout: 10m
          script: |
            set -e
            ROOT="${{ secrets.CLIENT_HEROE_BACKEND_DEPLOY_PATH }}"
            echo "ðŸš€ Deploying backend Heroe del Whisky (VPS2)..."
            cd "$ROOT"
            git fetch origin
            git reset --hard origin/master
            cd apps/backend
            COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --no-interaction --optimize-autoloader --ignore-platform-req=ext-soap
            php artisan migrate --force
            php artisan admin:grant-all-permissions --force 2>/dev/null || true
            php artisan config:clear 2>/dev/null || true
            php artisan cache:clear 2>/dev/null || true
            php artisan route:clear 2>/dev/null || true
            php artisan view:clear 2>/dev/null || true
            echo "âœ… Heroe backend deploy done"
          script_stop: true
